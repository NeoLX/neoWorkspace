'use strict'

var fs = require('fs');
var pather = require('path');
var url = require('url');
var util = require('util');
var events = require('events');
var http = require('http');
var router = require('./router');
var express = require('express');
var server = require('./server').createInstance();
var appbase = require('./appbase');

var Obj = {};

Obj.createInstance = function(){
		
	var base = appbase();

	var Lobby = base.extend({

		_path:null,
		_sysConfig:null,
		_serverPool:null,

		init:
			function(path){

				this._super("LOBBY_SYSTEM");

				if(!path || path.trim() == ""){
					console.log("[ROOT_DIC_ERROR]" + root);
					return;
				}else{
					this._path = path;
				}

				this._serverPool = {};

				try {

					var data = fs.readFileSync(path + "/lobby.json", 'utf8');
					
					this._sysConfig = JSON.parse(data);

				} catch (e) {

					this.log("CANNOT_READ_SYSTEM_CONFIG");
					this.log(e);
				}

				if(this._sysConfig.servers
					&& this._sysConfig.servers instanceof Array){
					
					for(var i in this._sysConfig.servers){

						var serverConfig = this._sysConfig.servers[i];

						serverConfig.path = pather.normalize(this._path + "/" + serverConfig.path);

						this._serverPool[serverConfig.name] 
							= new server(serverConfig);
					}
				}
			},

		startEngine:
			function(){
				for(var serverName in this._serverPool){
					this._serverPool[serverName].start();
				}
			}
	});

	return Lobby;
}

module.exports = Obj;
