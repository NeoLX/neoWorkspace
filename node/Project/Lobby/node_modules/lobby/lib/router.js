'use strict'

var fs = require('fs');
var events = require('events');
var url = require("url");
var util = require('util');
var express = require('express');
var path = require('path');
// var cookie = require('cookie');
// var uuid = require('uuid');

function Router(root, webpath){

    console.log("[CREATE ROUTER]" + root + webpath);

    var _root = "";

	if(!webpath || webpath.trim() == ""){
		console.log("[ROOT_DIC_ERROR]" + webpath);
		return;
	}else{
		console.log('[CREATE ROUTER ON]%s', webpath);
		_root = root + webpath;
		if(_root.trim().substring(_root.length-1) != '/'){
			_root += '/';
		} 
	}

    var webConfig = Router.webConfigInit(_root);
    var r = null;

    if(webConfig){
     
        r = express.Router();
        r.extras = {};
        r.extras.path = webConfig.webapp.root;
        
        console.log("[CREATE STATIC ON]%s[PATH]%s", webpath, _root);
        r.use(express.static(_root));   
    }
    return r;
};
//util.inherits(Router,events);

Router.webConfigInit = function(root){
    
    var webConfig = {};
    
    try{        
	    webConfig = require(root + 'web.json');
    }catch(e){
        console.log(e);
        return null;    
    }
    
    if(!webConfig.webapp.root){
        webConfig.webapp.root = "/";
    }
    
    if(!webConfig.webapp.defaultPage){
        webConfig.webapp.defaultPage = "index.html";
    }
    
    return webConfig;
}

Router.getInstance = function(root, file, callback){

	var cb = callback;

	fs.stat(root +  file,

		function(err, stat){
			if(err){
				console.log('[NO SUCH WEBCONTENT]' + err);
			}else if(stat.isDirectory()){

				var r = Router(root, file);
			
				if(r){
					cb(r);
				}																									
			}
		});										
}

module.exports = Router;